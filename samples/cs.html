<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualization of Search Algorithms</title>
    <script src = "https://d3js.org/d3.v3.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src = "html2canvas.min.js"></script>
</head>

<body>
    <div id="button-wrapper" data-html2canvas-ignore="true">
        <button id="showTree" class="button" onclick="showTree()">Show Solution</button>
        <button id="animation" class="button" onclick="animation()">Animation</button>
        <button id="step" class="button" onclick="step()">Step</button>
        <button id="stepBack" class="button" onclick="stepBack()">StepBack</button>
        <button id="reset" class="button" onclick="reset()">Reset</button>
        <button id="screenShot" class="button" onclick="saveTreeToPng()">SavePng</button>
        <label for="heightSlider">H</label><input type="range" min="1" max="9" value=5 class="slider" id="heightSlider">
        <label for="widthSlider">W</label><input type="range" min="1" max="9" value="3" class="slider" id="widthSlider">
        <button id="showConfig" class="button" onclick="showConfig()">Show/Hide CFG</button>
        <form id="myform" action = "http://localhost:9999/cgi/call_create_tree.cgi" method="get"> <!-- on server it is action = create_tree.cgi-->
            <textarea spellcheck="false" name="new_config_file" id="configFile" rows = "50" cols = "70"></textarea>
            <input id="submit_button" type = "submit" value = "Generate New Tree"/>
        </form>
        <a href="help.html" id="help" target="_blank">Config Explanation</a>
    </div>
    <div contenteditable="true" spellcheck="false" id="description"></div>

</body>


<style>
table {
    display : block;
    font-family: arial, sans-serif;
    border-collapse: collapse;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
}

.button {
    -webkit-tap-highlight-color: transparent;
    border:none;
    color: black;
    padding: 8px 4px;
    min-width: 96px;
    text-align: center;
    display: inline-block;
    font-family:monospace;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 20px;
}
.slider {
    -webkit-appearance: none;
    width: 10%;
    height: 10px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

#description {
    display : block;
    position : absolute;
    background : transparent;
    padding : 10px;
    width: 1000px;
    height: 55px;
    /*font-size:large;
    font-weight: bold;*/
    font-family:Times, "Times New Roman", serif;
}

#myform {
    display: inline;
    background : transparent;
    border-color : transparent;
    border-style : none;
    visibility : hidden;
}

#submit_button {
    position:absolute;
    color: black;
    min-width: 96px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-family:monospace;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 20px;
}

#help {
    position:absolute;
    background-color: #f44336;
    color: white;
    margin-left: 300px;
    padding: 5px 75px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    visibility:hidden;
}

#configFile {
    display:inline-block;
    position: absolute;
    margin-top:30px;
}

    #description { font-size : 16px; }
    .level { font-size : 20px; }
    .sideLabels, .label1, .nodeName, .edgeLabelsLeft, .edgeLabelsRight { font-size : 24px; }
</style>
<script>
var labels = ["A","B","C","D"];
var treeData = {
 "name" : "",
 "nodeOrder" : 1,
 "children" : [
 {
  "name" : "",
  "nodeOrder" : 2,
  "edgeLabelLeft" : "6",
  "children" : [
  {
   "name" : "",
   "nodeOrder" : 3,
   "edgeLabelLeft" : "2",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 4,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 5,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 38,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 39,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 6,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 7,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 40,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 41,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 42,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 43,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 44,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 45,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 8,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 9,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 10,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 46,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 47,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 48,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 49,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 50,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 51,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 52,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 53,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 54,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 55,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 11,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 12,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 13,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 56,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 57,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 58,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 59,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 60,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 61,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 62,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 63,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 64,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 65,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 14,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 15,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 16,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 66,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 67,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 68,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 69,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 70,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 71,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 72,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 73,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 74,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 75,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 17,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 18,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 19,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 76,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 77,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 78,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 79,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 80,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 81,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 82,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 83,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 84,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 85,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
}  
]
 
},
 {
  "name" : "",
  "nodeOrder" : 20,
  "edgeLabelLeft" : "6",
  "children" : [
  {
   "name" : "",
   "nodeOrder" : 21,
   "edgeLabelLeft" : "2",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 22,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 23,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 86,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 87,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 24,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 25,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 88,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 89,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 90,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 91,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 92,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 93,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 26,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 27,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 28,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 94,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 95,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 96,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 97,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 98,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 99,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 100,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 101,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 102,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 103,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 29,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 30,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 31,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 104,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 105,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 106,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 107,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 108,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 109,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 110,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 111,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 112,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 113,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 32,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 33,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 34,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 114,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 115,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 116,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 117,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 118,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 119,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 120,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 121,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 122,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 123,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
},
  {
   "name" : "",
   "nodeOrder" : 35,
   "edgeLabelLeft" : "1",
   "children" : [
   {
    "name" : "",
    "nodeOrder" : 36,
    "edgeLabelLeft" : "1",
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 37,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 124,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 125,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 126,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 127,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 128,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 129,
     "nodeColor" : "blank"    
}    
]
   
},
   {
    "name" : "",
    "nodeOrder" : 130,
    "children" : [
    {
     "name" : "",
     "nodeOrder" : 131,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 132,
     "nodeColor" : "blank"    
},
    {
     "name" : "",
     "nodeOrder" : 133,
     "nodeColor" : "blank"    
}    
]
   
}   
]
  
}  
]
 
} 
]
};
const node_size=400;
const stroke_width=1.5;
const coloredLimit=36;
let show_frame=true;
const padding_x = 200;
const padding_y = 90;
const most_right_label_padding = 150;
const most_down_label_padding = 50;
const between_node_label_gap = 10;
let tree_width = 960;
let tree_height = 180;
let treeRevealed = false;
let animationOn = false;
let nodes;
let links;
let nodeGap = 0;
let counter = 1;
let jumpOn = false;
let cfg_shown = false;

init();

function init() {
    let svg = d3.select("body").append("svg");
    let canvas = svg.attr({
        "width" : tree_width+padding_x+most_right_label_padding,
        "height" : padding_y + (tree_height*(labels.length+1)) + most_down_label_padding
    })
        .append("g")
        .attr("transform", "translate(" + padding_x + "," + padding_y + ")");

    let tree = d3.layout.tree()
        .size([tree_width]);

    nodes = tree.nodes(treeData);
    links = getLinks();

    addTreeLabel(canvas);
    addMarkers(svg);
    addLinks(canvas);
    addRightEdgeLabels(canvas);
    addLeftEdgeLabels(canvas);
    let node = addNodes(canvas);
    addNodeShape(node);
    addNodeName(node);
    addBottomLabel(node);
    addSideLabels();
    addJumps(svg);
    if (show_frame) {
        for (let i = counter; i <= nodes.length; i++) {
            jumpOn = true;
            showFrameOnly(i);
        treeRevealed = true;
        counter = 1;
        jumpOn = false;
        }
    }
}

function addJumps(svg) {
    var lineFunction = d3.svg.line()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .interpolate("basis");

    for (let i = 0; i < nodes.length; i++) {
        var y = getNode(nodes[i].nodeOrder).y - ((getNode(nodes[i].nodeOrder).y-getNode(nodes[i].jump).y)/2);
        if (typeof nodes[i].jump !== "undefined") {
            svg.append("path")
                .attr("id", "jump-" + nodes[i].nodeOrder)
                .attr("stroke-width", "3px")
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("d", lineFunction([
                    { "x" : getNode(nodes[i].nodeOrder).x, "y" : getNode(nodes[i].nodeOrder).y-10 },
                    { "x" : getNode(nodes[i].jump).x-80, "y" : y},
                    { "x" : getNode(nodes[i].jump).x, "y" : getNode(nodes[i].jump).y }
                ]))
                .attr("transform", "translate(" + padding_x + "," + padding_y + ")")
                .attr("visibility", "hidden")
                .attr("stroke-dasharray", ("3, 3"))
                .attr("marker-end", "url(#arrowToNode)");
        }
    }
}

function getNode(index) {
    for (let i=0;i<nodes.length;i++) {
        if (nodes[i].nodeOrder === index) {
            return nodes[i];
        }
    }
    return -1;
}

function getLinks() {
    let links = [];
    for(let i=1; i < nodes.length; i++) {
        let target = getNode(i+1);
        if (target !== -1) {
            links.push( { source : target.parent, target : target } );
        }
    }
    return links;
}

function addMarkers(svg) {
    svg.append("marker")
        .attr("id", "arrowToNode")
        .attr("viewBox", "-0 -5 10 10")
        .attr("refX", 14)
        .attr("refY", 0)
        .attr("orient", "auto")
        .attr("markerWidth", 20)
        .attr("markerHeight", 20)
        .attr("markerUnits", "userSpaceOnUse")
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', "none")
        .style('stroke','black');

    svg.append("marker")
        .attr("id", "arrowFromNode")
        .attr("viewBox", "-0 -5 10 10")
        .attr("refX", 16)
        .attr("refY", 0)
        .attr("orient", "auto-start-reverse")
        .attr("markerWidth", 20)
        .attr("markerHeight", 20)
        .attr("markerUnits", "userSpaceOnUse")
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', "none")
        .style('stroke','black');
}

function addLinks(canvas) {
    let id_counter = 0;
    canvas.selectAll(".link")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("id", function (d) { return "link-"+d.id})
        .attr('x1', function (d) {return d.source.x;})
        .attr('x2', function (d) {return d.target.x;})
        .attr('y1', function (d) {return d.source.y;})
        .attr('y2', function (d) {return d.target.y;})
        .attr("stroke", "black")
        .attr("stroke-width", stroke_width)
        .attr("stroke-dasharray", function(d) { return d.target.dashLine === "yes" ? ("3, 3") : ("0, 0")})
        .attr("visibility", "hidden")
        .attr("marker-end", function(d) { return d.target.arrowToNode === "yes" ? "url(#arrowToNode)" : "url()"})
        .attr("marker-start", function(d) { return d.target.arrowFromNode === "yes" ? "url(#arrowFromNode)" : "url()"});
}

function countLeftLabelShift(line) {
    let multiply_constant = 2;
    let opposite = line.target.y-line.source.y;
    let the_leg = Math.abs(line.target.x-line.source.x);
    let hypotenuse = Math.sqrt(opposite*opposite+the_leg*the_leg);
    let angle = Math.asin(opposite/hypotenuse);
    let shift = (10/angle)*multiply_constant;
    if(line.source.x > line.target.x) {
        return line.source.x - (the_leg/2) - shift;
    }
    else if(line.source.x < line.target.x) {
        let angle = Math.asin(opposite/hypotenuse);
        let shift = (10/angle)*multiply_constant;
        return line.target.x - ((the_leg)/2) - shift;
    }
    else {
        return line.target.x -15;
    }
}

function countRightLabelShift(line) {
    let multiply_constant = 2;
    let opposite = line.target.y-line.source.y;
    let the_leg = Math.abs(line.target.x-line.source.x);
    let hypotenuse = Math.sqrt(opposite*opposite+the_leg*the_leg);
    let angle = Math.asin(opposite/hypotenuse);
    let shift = (10/angle)*multiply_constant;
    if(line.source.x > line.target.x) {
        return line.source.x - (the_leg/2) + shift;
    }
    else if(line.source.x < line.target.x) {
        let angle = Math.asin(opposite/hypotenuse);
        let shift = (10/angle)*multiply_constant;
        return line.target.x - ((the_leg)/2);
    }
    else {
        return line.target.x + 15;
    }
}


function addRightEdgeLabels(canvas) {
    let id_counter = 0;
    canvas.selectAll(".edgeLabelsRight")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("text")
        .attr("class", "edgeLabelsRight")
        .attr("id", function(d) { return "edgeLabelRight-"+d.id })
        .attr("y", function(d) { return d.target.y - ((d.target.y - d.source.y) / 2)})
        .attr("x", function(d) { return countRightLabelShift(d)})
        .text(function(d) { return d.target.edgeLabelRight; })
        .attr("visibility", "hidden")
        .attr("font-weight", "bold");
}

function addLeftEdgeLabels(canvas) {
    let id_counter = 0;
    canvas.selectAll(".edgeLabelsLeft")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("text")
        .attr("class", "edgeLabelsLeft")
        .attr("id", function(d) { return "edgeLabelLeft-"+d.id })
        .attr("y", function(d) { return d.target.y - ((d.target.y - d.source.y) / 2)})
        .attr("x", function(d) { return countLeftLabelShift(d)})
        .attr("width", "100px")
        .text(function(d) { return d.target.edgeLabelLeft; })
        .style("overflow", "hidden")
        .attr("visibility", "hidden")
        .attr("font-weight", "bold");
}

function addNodes(canvas) {
    let id_counter = 0;
    let node = canvas.selectAll(".node")
        .data(nodes, function (d) { return d.id = nodes[id_counter++].nodeOrder; })
        .enter()
        .append("g")
        .attr("id", function(d) { return "g-node-" +d.id})
        .attr("class", "node")
        .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    return node;
}

function addNodeShape(node) {
    node.append("path")
        .style("stroke", "black")
        .attr("visibility", "hidden")
        .attr("id",function(d){return "node-"+d.id})
        .style("fill", function(d) { return d.nodeColor === 'blank' ? "white" : d.nodeColor })
        .attr("d", d3.svg.symbol()
            .size(function() { return typeof node_size === "undefined" ? 400 : node_size})
            .type(function(d) { return d.shape === "rectangle" ? "square" : "circle"}));
}

function addNodeName(node) {
    node.append("text")
        .attr("class", "nodeName")
        .text(function (d) {return d.name; })
        .attr("id",function(d){return "text-"+d.id})
        .attr("visibility", "hidden")
        .style("fill", function(d) { return typeof d.nodeColor === "undefined" ? "white" : "black" })
        .attr({
            "y" : 5,
            "x" : -4,
            "font-weight" : "bold"
        });
}

function addBottomLabel(node) {
    node.append("text")
        .attr("class", "label1")
        .text(function(d) { return d.label1; })
        .attr({
            "id" : function(d) { return "nodeLabel1-"+d.id; },
            "visibility" : "hidden",
            "text-anchor" : "middle",
            "y" : function() { return typeof node_size === "undefined" ? 400/between_node_label_gap : node_size/between_node_label_gap},
            "font-weight" : "bold",
        });
}

/*
Because of the fact that doing node.append("text") I cannot append more than one text element i had to do external
function which uses original "nodes" data and nodeOrder as a transformation index to current node elements
 */
function addSideLabels() {
    for(let i=0;i<nodes.length;i++) {
        if (typeof nodes[i].sideLabels !== "undefined") {
            for(let j=0; j<nodes[i].sideLabels.length; j++) {
                d3.select("#g-node-" + nodes[i].nodeOrder)
                    .append("text")
                    .attr("id","sideLabel-"+nodes[i].nodeOrder)
                    .attr("class", "sideLabels")
                    .attr("visibility", "hidden")
                    .text(nodes[i].sideLabels[j])
                    .attr({
                        "x" : 20,
                        "y" : (j*18)+5,
                        "font-weight" : "bold"
                    })
            }
        }
    }
}

function reveal(element) {
    d3.select(element).attr("visibility", "visible");
}

function revealAll(element) {
    d3.selectAll(element).attr("visibility", "visible");
}

function hide(element) {
    d3.select(element).attr("visibility", "hidden");
}

function hideAll(element) {
    d3.selectAll(element).attr("visibility", "hidden");
}

function revealBackJump(i) {
    if (typeof getNode(i).jump !== "undefined") {
        if (jumpOn) {
            if (treeRevealed) {
                d3.select("#jump-"+i).attr("stroke", "red")
            }
            else {
                reveal("#jump-"+i);
            }
            jumpOn = false;
        }
        else {
            jumpOn = true;
            counter--;
        }
    }
}

function hideBackJump(i) {
    if (typeof getNode(i).jump !== "undefined") {
        if (!jumpOn) {
            if (treeRevealed) {
                d3.select("#jump-"+i).attr("stroke", "black")
            }
            else {
                hide("#jump-"+i);
            }
            jumpOn = true;
            counter++;
        }
        else {
            jumpOn = false;
        }
    }
}

function showFrameOnly(i) {
    reveal("#link-" + (i - 1));
    reveal("#node-" + i);
    let node = getNode(i);
    if (node !== -1) {
        reveal("#treeLabel-" + (node.depth - 1));
    }
    revealBackJump(i)
}

function showNode(i) {
    if(treeRevealed) {
        if (typeof coloredLimit === "undefined" || i < coloredLimit+1) {
            if (show_frame) {
                reveal("#text-"+ (i+1));
                reveal("#nodeLabel1-"+ (i+1));
                reveal("#edgeLabelLeft-" + i);
                reveal("#edgeLabelRight-"+ i);
                revealAll("#sideLabel-"+ (i+1));
            }
            d3.select("#link-" + i)
                .attr("stroke", "red")
                .attr("stroke-width", stroke_width*2);
            revealBackJump(i+1); // nodes reveals 1-time faster than links
        }
    }
    else {
        reveal("#link-" + (i-1));
        reveal("#edgeLabelLeft-" + (i-1));
        reveal("#edgeLabelRight-"+ (i-1));
        reveal("#node-"+ i);
        reveal("#text-"+ i);
        reveal("#nodeLabel1-"+ i);
        reveal("#nodeLabel2-"+ i);
        revealAll("#sideLabel-"+ i);

        let node = getNode(i);
        if (node !== -1) {
            reveal("#treeLabel-" + (node.depth-1));
        }
        revealBackJump(i)
    }
}

function hideNode(i) {
    if(treeRevealed) {
        hideBackJump(i+1);
        i = counter;
        d3.select("#link-" + i)
            .attr("stroke", "black")
            .attr("stroke-width", stroke_width);
    }
    else {
        hideBackJump(i);
        i = counter;
        hide("#link-" + (i-1));
        hide("#edgeLabelLeft-" + (i-1));
        hide("#edgeLabelRight-"+ (i-1));
        hide("#node-"+ i);
        hide("#text-"+ i);
        hide("#nodeLabel1-"+ i);
        hide("#nodeLabel2-"+ i);
        hideAll("#sideLabel-"+ i);
        hide("#jump-"+i)
    }
}

function showTree() {
    if (animationOn) {
        pause();
    }
    for (let i = counter; i<=nodes.length; i++) {
        jumpOn = true;
        showNode(i);
    }
    treeRevealed = true;
    counter = 1;
    jumpOn = false;
}

function step() {
    if (animationOn) {
        pause();
    }
    if(counter <= nodes.length) {
        showNode(counter);
        counter++;
    }
}

function stepBack() {
    if (animationOn) {
        pause();
    }
    if(counter > 1) {
        counter--;
        hideNode(counter);
    }
}

function pause() {
    document.getElementById("animation").innerHTML = "Animation";
    document.getElementById("animation").style.backgroundColor = "";
    clearInterval(interval);
    animationOn = false;
}

function timeNodes() {
    if (show_frame && counter > coloredLimit) {
        pause();
    }
    else {
        if(counter <= nodes.length) {
            showNode(counter);
            counter++;
        }
        else {
            pause();
        }
    }
}

function animation() {
    if (animationOn) {
        pause();
    }
    else {
        if(counter < nodes.length) {
            document.getElementById("animation").innerHTML = "Pause";
            document.getElementById("animation").style.backgroundColor = "red";
            window.interval = setInterval(timeNodes, 500)
            animationOn = true;
        }
    }
}

function addTreeLabel(canvas) {
    nodes.forEach(function(d) { d.y = d.depth * tree_height; });
    let depthHash = _.uniq(_.pluck(nodes, "depth")).sort();
    depthHash.shift();
    let levelSVG = canvas.append("g")
        .attr("class", "levels-svg");
    levelSVG.selectAll("g.level")
        .data(depthHash)
        .enter()
        .append("g")
        .attr("class", "level")
        .attr("transform", function(d) { return "translate(" + -20 + "," + d*tree_height + ")"; })
        .append("text")
        .text(function(d){ return labels[d-1]; })
        .attr({
            "id" : function(d) { return "treeLabel-" + (d-1); },
            "visibility" : "hidden",
            "font-weight" : "bold",
            //"font-size" : "30px",
            "font-family" : "monospace"
        });
}

function reset() {
    if (animationOn) {
        pause();
    }
    d3.selectAll("svg").remove();
    show_frame = false;
    init();
    nodeGap = 0;
    counter = 1;
    treeRevealed = false;
    animationOn = false;
}

function restoreTree(restoreUntil) {
    for(let i=1; i < restoreUntil; i++) {
        step();
    }
}

function restore() {
    let restoreUntil = counter;
    let wasRevealed = treeRevealed;
    reset();
    if(wasRevealed) {
        showTree();
    }
    else {
        restoreTree(restoreUntil);
    }
}

heightSlider.oninput = function() {
    tree_height = this.value*36;
    restore();
};

widthSlider.oninput = function() {
    tree_width = this.value*320;
    restore();
};

function saveTreeToPng() {
    html2canvas(document.body).then(function(canvas) {
        let image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
        window.location.href=image;
    });
}

function showConfig() {
    if (cfg_shown) {
        document.getElementById("configFile").style.visibility = "hidden";
        document.getElementById("submit_button").style.visibility = "hidden";
        document.getElementById("help").style.visibility = "hidden";
        cfg_shown = false;
    }
    else {
        document.getElementById("configFile").style.visibility = "visible";
        document.getElementById("submit_button").style.visibility = "visible";
        document.getElementById("help").style.visibility = "visible";
        cfg_shown = true;
    }
}
document.getElementById("description").innerHTML = "<p><strong>CS(12) CREDIT SEARCH</strong></p><table><tr><th>Variable</th><th>Domain</th></tr><tr><td>A</td><td>{ 1 2 }</td></tr><tr><td>B</td><td>{ 1 2 3 4 5 }</td></tr><tr><td>C</td><td>{ 1 2 3 }</td></tr><tr><td>D</td><td>{ 1 2 3 }</td></tr><tr><th>Constraints</th></tr><tr><td>No constraints</td></tr></table>";
document.getElementById("configFile").value = "#CS(12) CREDIT SEARCH\n#A 1 2,B 1 2 3 4 5,C 1 2 3,D 1 2 3\n#No constraints\n#description_size=16,node_size=400,edge_size=1.5,variable_label_size=20,node_label_size=24,show_frame=true,colored_limit=36\npath:=r0;name:=none;order:=1\npath:=r0A1;name:=none;order:=2;edge_label:=6;edge_label_position:=left\npath:=r0A1B1;name:=none;order:=3;edge_label:=2;edge_label_position:=left\npath:=r0A1B1C1;name:=none;order:=4;edge_label:=1;edge_label_position:=left\npath:=r0A1B1C1D1;name:=none;order:=5;color:=blank\npath:=r0A1B1C1D2;name:=none;order:=38;color:=blank\npath:=r0A1B1C1D3;name:=none;order:=39;color:=blank\npath:=r0A1B1C2;name:=none;order:=6;edge_label:=1;edge_label_position:=left\npath:=r0A1B1C2D1;name:=none;order:=7;color:=blank\npath:=r0A1B1C2D2;name:=none;order:=40;color:=blank\npath:=r0A1B1C2D3;name:=none;order:=41;color:=blank\npath:=r0A1B1C3;name:=none;order:=42\npath:=r0A1B1C3D1;name:=none;order:=43;color:=blank\npath:=r0A1B1C3D2;name:=none;order:=44;color:=blank\npath:=r0A1B1C3D3;name:=none;order:=45;color:=blank\npath:=r0A1B2;name:=none;order:=8;edge_label:=1;edge_label_position:=left\npath:=r0A1B2C1;name:=none;order:=9;edge_label:=1;edge_label_position:=left\npath:=r0A1B2C1D1;name:=none;order:=10;color:=blank\npath:=r0A1B2C1D2;name:=none;order:=46;color:=blank\npath:=r0A1B2C1D3;name:=none;order:=47;color:=blank\npath:=r0A1B2C2;name:=none;order:=48\npath:=r0A1B2C2D1;name:=none;order:=49;color:=blank\npath:=r0A1B2C2D2;name:=none;order:=50;color:=blank\npath:=r0A1B2C2D3;name:=none;order:=51;color:=blank\npath:=r0A1B2C3;name:=none;order:=52\npath:=r0A1B2C3D1;name:=none;order:=53;color:=blank\npath:=r0A1B2C3D2;name:=none;order:=54;color:=blank\npath:=r0A1B2C3D3;name:=none;order:=55;color:=blank\npath:=r0A1B3;name:=none;order:=11;edge_label:=1;edge_label_position:=left\npath:=r0A1B3C1;name:=none;order:=12;edge_label:=1;edge_label_position:=left\npath:=r0A1B3C1D1;name:=none;order:=13;color:=blank\npath:=r0A1B3C1D2;name:=none;order:=56;color:=blank\npath:=r0A1B3C1D3;name:=none;order:=57;color:=blank\npath:=r0A1B3C2;name:=none;order:=58\npath:=r0A1B3C2D1;name:=none;order:=59;color:=blank\npath:=r0A1B3C2D2;name:=none;order:=60;color:=blank\npath:=r0A1B3C2D3;name:=none;order:=61;color:=blank\npath:=r0A1B3C3;name:=none;order:=62\npath:=r0A1B3C3D1;name:=none;order:=63;color:=blank\npath:=r0A1B3C3D2;name:=none;order:=64;color:=blank\npath:=r0A1B3C3D3;name:=none;order:=65;color:=blank\npath:=r0A1B4;name:=none;order:=14;edge_label:=1;edge_label_position:=left\npath:=r0A1B4C1;name:=none;order:=15;edge_label:=1;edge_label_position:=left\npath:=r0A1B4C1D1;name:=none;order:=16;color:=blank\npath:=r0A1B4C1D2;name:=none;order:=66;color:=blank\npath:=r0A1B4C1D3;name:=none;order:=67;color:=blank\npath:=r0A1B4C2;name:=none;order:=68\npath:=r0A1B4C2D1;name:=none;order:=69;color:=blank\npath:=r0A1B4C2D2;name:=none;order:=70;color:=blank\npath:=r0A1B4C2D3;name:=none;order:=71;color:=blank\npath:=r0A1B4C3;name:=none;order:=72\npath:=r0A1B4C3D1;name:=none;order:=73;color:=blank\npath:=r0A1B4C3D2;name:=none;order:=74;color:=blank\npath:=r0A1B4C3D3;name:=none;order:=75;color:=blank\npath:=r0A1B5;name:=none;order:=17;edge_label:=1;edge_label_position:=left\npath:=r0A1B5C1;name:=none;order:=18;edge_label:=1;edge_label_position:=left\npath:=r0A1B5C1D1;name:=none;order:=19;color:=blank\npath:=r0A1B5C1D2;name:=none;order:=76;color:=blank\npath:=r0A1B5C1D3;name:=none;order:=77;color:=blank\npath:=r0A1B5C2;name:=none;order:=78\npath:=r0A1B5C2D1;name:=none;order:=79;color:=blank\npath:=r0A1B5C2D2;name:=none;order:=80;color:=blank\npath:=r0A1B5C2D3;name:=none;order:=81;color:=blank\npath:=r0A1B5C3;name:=none;order:=82\npath:=r0A1B5C3D1;name:=none;order:=83;color:=blank\npath:=r0A1B5C3D2;name:=none;order:=84;color:=blank\npath:=r0A1B5C3D3;name:=none;order:=85;color:=blank\npath:=r0A2;name:=none;order:=20;edge_label:=6;edge_label_position:=left\npath:=r0A2B1;name:=none;order:=21;edge_label:=2;edge_label_position:=left\npath:=r0A2B1C1;name:=none;order:=22;edge_label:=1;edge_label_position:=left\npath:=r0A2B1C1D1;name:=none;order:=23;color:=blank\npath:=r0A2B1C1D2;name:=none;order:=86;color:=blank\npath:=r0A2B1C1D3;name:=none;order:=87;color:=blank\npath:=r0A2B1C2;name:=none;order:=24;edge_label:=1;edge_label_position:=left\npath:=r0A2B1C2D1;name:=none;order:=25;color:=blank\npath:=r0A2B1C2D2;name:=none;order:=88;color:=blank\npath:=r0A2B1C2D3;name:=none;order:=89;color:=blank\npath:=r0A2B1C3;name:=none;order:=90\npath:=r0A2B1C3D1;name:=none;order:=91;color:=blank\npath:=r0A2B1C3D2;name:=none;order:=92;color:=blank\npath:=r0A2B1C3D3;name:=none;order:=93;color:=blank\npath:=r0A2B2;name:=none;order:=26;edge_label:=1;edge_label_position:=left\npath:=r0A2B2C1;name:=none;order:=27;edge_label:=1;edge_label_position:=left\npath:=r0A2B2C1D1;name:=none;order:=28;color:=blank\npath:=r0A2B2C1D2;name:=none;order:=94;color:=blank\npath:=r0A2B2C1D3;name:=none;order:=95;color:=blank\npath:=r0A2B2C2;name:=none;order:=96\npath:=r0A2B2C2D1;name:=none;order:=97;color:=blank\npath:=r0A2B2C2D2;name:=none;order:=98;color:=blank\npath:=r0A2B2C2D3;name:=none;order:=99;color:=blank\npath:=r0A2B2C3;name:=none;order:=100\npath:=r0A2B2C3D1;name:=none;order:=101;color:=blank\npath:=r0A2B2C3D2;name:=none;order:=102;color:=blank\npath:=r0A2B2C3D3;name:=none;order:=103;color:=blank\npath:=r0A2B3;name:=none;order:=29;edge_label:=1;edge_label_position:=left\npath:=r0A2B3C1;name:=none;order:=30;edge_label:=1;edge_label_position:=left\npath:=r0A2B3C1D1;name:=none;order:=31;color:=blank\npath:=r0A2B3C1D2;name:=none;order:=104;color:=blank\npath:=r0A2B3C1D3;name:=none;order:=105;color:=blank\npath:=r0A2B3C2;name:=none;order:=106\npath:=r0A2B3C2D1;name:=none;order:=107;color:=blank\npath:=r0A2B3C2D2;name:=none;order:=108;color:=blank\npath:=r0A2B3C2D3;name:=none;order:=109;color:=blank\npath:=r0A2B3C3;name:=none;order:=110\npath:=r0A2B3C3D1;name:=none;order:=111;color:=blank\npath:=r0A2B3C3D2;name:=none;order:=112;color:=blank\npath:=r0A2B3C3D3;name:=none;order:=113;color:=blank\npath:=r0A2B4;name:=none;order:=32;edge_label:=1;edge_label_position:=left\npath:=r0A2B4C1;name:=none;order:=33;edge_label:=1;edge_label_position:=left\npath:=r0A2B4C1D1;name:=none;order:=34;color:=blank\npath:=r0A2B4C1D2;name:=none;order:=114;color:=blank\npath:=r0A2B4C1D3;name:=none;order:=115;color:=blank\npath:=r0A2B4C2;name:=none;order:=116\npath:=r0A2B4C2D1;name:=none;order:=117;color:=blank\npath:=r0A2B4C2D2;name:=none;order:=118;color:=blank\npath:=r0A2B4C2D3;name:=none;order:=119;color:=blank\npath:=r0A2B4C3;name:=none;order:=120\npath:=r0A2B4C3D1;name:=none;order:=121;color:=blank\npath:=r0A2B4C3D2;name:=none;order:=122;color:=blank\npath:=r0A2B4C3D3;name:=none;order:=123;color:=blank\npath:=r0A2B5;name:=none;order:=35;edge_label:=1;edge_label_position:=left\npath:=r0A2B5C1;name:=none;order:=36;edge_label:=1;edge_label_position:=left\npath:=r0A2B5C1D1;name:=none;order:=37;color:=blank\npath:=r0A2B5C1D2;name:=none;order:=124;color:=blank\npath:=r0A2B5C1D3;name:=none;order:=125;color:=blank\npath:=r0A2B5C2;name:=none;order:=126\npath:=r0A2B5C2D1;name:=none;order:=127;color:=blank\npath:=r0A2B5C2D2;name:=none;order:=128;color:=blank\npath:=r0A2B5C2D3;name:=none;order:=129;color:=blank\npath:=r0A2B5C3;name:=none;order:=130\npath:=r0A2B5C3D1;name:=none;order:=131;color:=blank\npath:=r0A2B5C3D2;name:=none;order:=132;color:=blank\npath:=r0A2B5C3D3;name:=none;order:=133;color:=blank";
</script>
</html>