<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visualization of Search Algorithms</title>
    <script src = "https://d3js.org/d3.v3.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src = "html2canvas.min.js"></script>
</head>

<body>
    <div id="button-wrapper" data-html2canvas-ignore="true">
        <button id="showTree" class="button" onclick="showTree()">Show Solution</button>
        <button id="animation" class="button" onclick="animation()">Animation</button>
        <button id="step" class="button" onclick="step()">Step</button>
        <button id="stepBack" class="button" onclick="stepBack()">StepBack</button>
        <button id="reset" class="button" onclick="reset()">Reset</button>
        <button id="screenShot" class="button" onclick="saveTreeToPng()">SavePng</button>
        <label for="heightSlider">H</label><input type="range" min="1" max="9" value=5 class="slider" id="heightSlider">
        <label for="widthSlider">W</label><input type="range" min="1" max="9" value="3" class="slider" id="widthSlider">
        <button id="showConfig" class="button" onclick="showConfig()">Show/Hide CFG</button>
        <form id="myform" action = "http://localhost:9999/cgi/call_create_tree.cgi" method="get"> <!-- on server it is action = create_tree.cgi-->
            <textarea spellcheck="false" name="new_config_file" id="configFile" rows = "50" cols = "70"></textarea>
            <input id="submit_button" type = "submit" value = "Generate New Tree"/>
        </form>
        <a href="help.html" id="help" target="_blank">Config Explanation</a>
    </div>
    <div contenteditable="true" spellcheck="false" id="description"></div>

</body>


<style>
table {
    display : block;
    font-family: arial, sans-serif;
    border-collapse: collapse;
}

td, th {
    border: 1px solid #dddddd;
    text-align: left;
}

.button {
    -webkit-tap-highlight-color: transparent;
    border:none;
    color: black;
    padding: 8px 4px;
    min-width: 96px;
    text-align: center;
    display: inline-block;
    font-family:monospace;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 20px;
}
.slider {
    -webkit-appearance: none;
    width: 10%;
    height: 10px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

#description {
    display : block;
    position : absolute;
    background : transparent;
    padding : 10px;
    width: 1000px;
    height: 55px;
    /*font-size:large;
    font-weight: bold;*/
    font-family:Times, "Times New Roman", serif;
}

#myform {
    display: inline;
    background : transparent;
    border-color : transparent;
    border-style : none;
    visibility : hidden;
}

#submit_button {
    position:absolute;
    color: black;
    min-width: 96px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-family:monospace;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 20px;
}

#help {
    position:absolute;
    background-color: #f44336;
    color: white;
    margin-left: 300px;
    padding: 5px 75px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    visibility:hidden;
}

#configFile {
    display:inline-block;
    position: absolute;
    margin-top:30px;
}

    #description { font-size : 16px; }
    .level { font-size : 20px; }
    .sideLabels, .label1, .nodeName, .edgeLabelsLeft, .edgeLabelsRight { font-size : 16px; }
</style>
<script>
var labels = ["x1","x2","x3","x4","x5","x6","x7"];
var treeData = {
 "name" : "",
 "nodeOrder" : 1,
 "children" : [
 {
  "name" : "1",
  "nodeOrder" : 2,
  "children" : [
  {
   "name" : "2",
   "nodeOrder" : 3,
   "children" : [
   {
    "name" : "1",
    "nodeOrder" : 4,
    "jump" : 1,
    "children" : [
    {
     "name" : "1",
     "nodeOrder" : 5,
     "shape" : "rectangle",
     "nodeColor" : "red",
     "label1" : "(c2)"    
},
    {
     "name" : "2",
     "nodeOrder" : 6,
     "children" : [
     {
      "name" : "2",
      "nodeOrder" : 7,
      "shape" : "rectangle",
      "nodeColor" : "red",
      "label1" : "(c6)"     
},
     {
      "name" : "3",
      "nodeOrder" : 8,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 9,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 10,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c3)",
        "jump" : 4       
}       
]
      
}      
]
     
}     
]
    
}    
]
   
}   
]
  
},
  {
   "name" : "3",
   "nodeOrder" : 11,
   "children" : [
   {
    "name" : "1",
    "nodeOrder" : 12,
    "children" : [
    {
     "name" : "1",
     "nodeOrder" : 13,
     "shape" : "rectangle",
     "nodeColor" : "red",
     "label1" : "(c2)"    
},
    {
     "name" : "2",
     "nodeOrder" : 14,
     "children" : [
     {
      "name" : "2",
      "nodeOrder" : 15,
      "shape" : "rectangle",
      "nodeColor" : "red",
      "label1" : "(c6)"     
},
     {
      "name" : "3",
      "nodeOrder" : 16,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 17,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 18,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c3)",
        "jump" : 11       
}       
]
      
}      
]
     
}     
]
    
}    
]
   
}   
]
  
}  
]
 
},
 {
  "name" : "2",
  "nodeOrder" : 19,
  "children" : [
  {
   "name" : "2",
   "nodeOrder" : 20,
   "shape" : "rectangle",
   "nodeColor" : "red",
   "label1" : "(c1)"  
},
  {
   "name" : "3",
   "nodeOrder" : 21,
   "jump" : 1,
   "children" : [
   {
    "name" : "1",
    "nodeOrder" : 22,
    "children" : [
    {
     "name" : "1",
     "nodeOrder" : 23,
     "children" : [
     {
      "name" : "2",
      "nodeOrder" : 24,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 25,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 26,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c5)",
        "jump" : 21       
}       
]
      
}      
]
     
}     
]
    
}    
]
   
}   
]
  
}  
]
 
},
 {
  "name" : "3",
  "nodeOrder" : 27,
  "children" : [
  {
   "name" : "2",
   "nodeOrder" : 28,
   "children" : [
   {
    "name" : "1",
    "nodeOrder" : 29,
    "children" : [
    {
     "name" : "1",
     "nodeOrder" : 30,
     "children" : [
     {
      "name" : "2",
      "nodeOrder" : 31,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 32,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 33,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c5)",
        "jump" : 30       
}       
]
      
}      
]
     
},
     {
      "name" : "3",
      "nodeOrder" : 34,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 35,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 36,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c5)"       
},
       {
        "name" : "2",
        "nodeOrder" : 37,
        "nodeColor" : "blank"       
}       
]
      
},
      {
       "name" : "3",
       "nodeOrder" : 38,
       "shape" : "rectangle",
       "nodeColor" : "red",
       "label1" : "(c8)"      
},
      {
       "name" : "4",
       "nodeOrder" : 39,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 40,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c5)"       
},
       {
        "name" : "2",
        "nodeOrder" : 41,
        "nodeColor" : "blank"       
}       
]
      
}      
]
     
}     
]
    
},
    {
     "name" : "2",
     "nodeOrder" : 42,
     "children" : [
     {
      "name" : "2",
      "nodeOrder" : 43,
      "shape" : "rectangle",
      "nodeColor" : "red",
      "label1" : "(c6)"     
},
     {
      "name" : "3",
      "nodeOrder" : 44,
      "children" : [
      {
       "name" : "1",
       "nodeOrder" : 45,
       "children" : [
       {
        "name" : "1",
        "nodeOrder" : 46,
        "shape" : "rectangle",
        "nodeColor" : "red",
        "label1" : "(c5)",
        "jump" : 29       
}       
]
      
}      
]
     
}     
]
    
}    
]
   
}   
]
  
},
  {
   "name" : "3",
   "nodeOrder" : 47,
   "shape" : "rectangle",
   "nodeColor" : "red",
   "label1" : "(c1)"  
}  
]
 
} 
]
};
const node_size=400;
const stroke_width=1.5;
let show_frame=false;
const padding_x = 200;
const padding_y = 90;
const most_right_label_padding = 150;
const most_down_label_padding = 50;
const between_node_label_gap = 10;
let tree_width = 960;
let tree_height = 180;
let treeRevealed = false;
let animationOn = false;
let nodes;
let links;
let nodeGap = 0;
let counter = 1;
let jumpOn = false;
let cfg_shown = false;

init();

function init() {
    let svg = d3.select("body").append("svg");
    let canvas = svg.attr({
        "width" : tree_width+padding_x+most_right_label_padding,
        "height" : padding_y + (tree_height*(labels.length+1)) + most_down_label_padding
    })
        .append("g")
        .attr("transform", "translate(" + padding_x + "," + padding_y + ")");

    let tree = d3.layout.tree()
        .size([tree_width]);

    nodes = tree.nodes(treeData);
    links = getLinks();

    addTreeLabel(canvas);
    addMarkers(svg);
    addLinks(canvas);
    addRightEdgeLabels(canvas);
    addLeftEdgeLabels(canvas);
    let node = addNodes(canvas);
    addNodeShape(node);
    addNodeName(node);
    addBottomLabel(node);
    addSideLabels();
    addJumps(svg);
    if (show_frame) {
        for (let i = counter; i <= nodes.length; i++) {
            jumpOn = true;
            showFrameOnly(i);
        treeRevealed = true;
        counter = 1;
        jumpOn = false;
        }
    }
}

function addJumps(svg) {
    var lineFunction = d3.svg.line()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .interpolate("basis");

    for (let i = 0; i < nodes.length; i++) {
        var y = getNode(nodes[i].nodeOrder).y - ((getNode(nodes[i].nodeOrder).y-getNode(nodes[i].jump).y)/2);
        if (typeof nodes[i].jump !== "undefined") {
            svg.append("path")
                .attr("id", "jump-" + nodes[i].nodeOrder)
                .attr("stroke-width", "3px")
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("d", lineFunction([
                    { "x" : getNode(nodes[i].nodeOrder).x, "y" : getNode(nodes[i].nodeOrder).y-10 },
                    { "x" : getNode(nodes[i].jump).x-80, "y" : y},
                    { "x" : getNode(nodes[i].jump).x, "y" : getNode(nodes[i].jump).y }
                ]))
                .attr("transform", "translate(" + padding_x + "," + padding_y + ")")
                .attr("visibility", "hidden")
                .attr("stroke-dasharray", ("3, 3"))
                .attr("marker-end", "url(#arrowToNode)");
        }
    }
}

function getNode(index) {
    for (let i=0;i<nodes.length;i++) {
        if (nodes[i].nodeOrder === index) {
            return nodes[i];
        }
    }
    return -1;
}

function getLinks() {
    let links = [];
    for(let i=1; i < nodes.length; i++) {
        let target = getNode(i+1);
        if (target !== -1) {
            links.push( { source : target.parent, target : target } );
        }
    }
    return links;
}

function addMarkers(svg) {
    svg.append("marker")
        .attr("id", "arrowToNode")
        .attr("viewBox", "-0 -5 10 10")
        .attr("refX", 14)
        .attr("refY", 0)
        .attr("orient", "auto")
        .attr("markerWidth", 20)
        .attr("markerHeight", 20)
        .attr("markerUnits", "userSpaceOnUse")
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', "none")
        .style('stroke','black');

    svg.append("marker")
        .attr("id", "arrowFromNode")
        .attr("viewBox", "-0 -5 10 10")
        .attr("refX", 16)
        .attr("refY", 0)
        .attr("orient", "auto-start-reverse")
        .attr("markerWidth", 20)
        .attr("markerHeight", 20)
        .attr("markerUnits", "userSpaceOnUse")
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', "none")
        .style('stroke','black');
}

function addLinks(canvas) {
    let id_counter = 0;
    canvas.selectAll(".link")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("id", function (d) { return "link-"+d.id})
        .attr('x1', function (d) {return d.source.x;})
        .attr('x2', function (d) {return d.target.x;})
        .attr('y1', function (d) {return d.source.y;})
        .attr('y2', function (d) {return d.target.y;})
        .attr("stroke", "black")
        .attr("stroke-width", stroke_width)
        .attr("stroke-dasharray", function(d) { return d.target.dashLine === "yes" ? ("3, 3") : ("0, 0")})
        .attr("visibility", "hidden")
        .attr("marker-end", function(d) { return d.target.arrowToNode === "yes" ? "url(#arrowToNode)" : "url()"})
        .attr("marker-start", function(d) { return d.target.arrowFromNode === "yes" ? "url(#arrowFromNode)" : "url()"});
}

function countLeftLabelShift(line) {
    let multiply_constant = 2;
    let opposite = line.target.y-line.source.y;
    let the_leg = Math.abs(line.target.x-line.source.x);
    let hypotenuse = Math.sqrt(opposite*opposite+the_leg*the_leg);
    let angle = Math.asin(opposite/hypotenuse);
    let shift = (10/angle)*multiply_constant;
    if(line.source.x > line.target.x) {
        return line.source.x - (the_leg/2) - shift;
    }
    else if(line.source.x < line.target.x) {
        let angle = Math.asin(opposite/hypotenuse);
        let shift = (10/angle)*multiply_constant;
        return line.target.x - ((the_leg)/2) - shift;
    }
    else {
        return line.target.x -15;
    }
}

function countRightLabelShift(line) {
    let multiply_constant = 2;
    let opposite = line.target.y-line.source.y;
    let the_leg = Math.abs(line.target.x-line.source.x);
    let hypotenuse = Math.sqrt(opposite*opposite+the_leg*the_leg);
    let angle = Math.asin(opposite/hypotenuse);
    let shift = (10/angle)*multiply_constant;
    if(line.source.x > line.target.x) {
        return line.source.x - (the_leg/2) + shift;
    }
    else if(line.source.x < line.target.x) {
        let angle = Math.asin(opposite/hypotenuse);
        let shift = (10/angle)*multiply_constant;
        return line.target.x - ((the_leg)/2);
    }
    else {
        return line.target.x + 15;
    }
}


function addRightEdgeLabels(canvas) {
    let id_counter = 0;
    canvas.selectAll(".edgeLabelsRight")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("text")
        .attr("class", "edgeLabelsRight")
        .attr("id", function(d) { return "edgeLabelRight-"+d.id })
        .attr("y", function(d) { return d.target.y - ((d.target.y - d.source.y) / 2)})
        .attr("x", function(d) { return countRightLabelShift(d)})
        .text(function(d) { return d.target.edgeLabelRight; })
        .attr("visibility", "hidden")
        .attr("font-weight", "bold");
}

function addLeftEdgeLabels(canvas) {
    let id_counter = 0;
    canvas.selectAll(".edgeLabelsLeft")
        .data(links, function(d) { return d.id = ++id_counter; })
        .enter()
        .append("text")
        .attr("class", "edgeLabelsLeft")
        .attr("id", function(d) { return "edgeLabelLeft-"+d.id })
        .attr("y", function(d) { return d.target.y - ((d.target.y - d.source.y) / 2)})
        .attr("x", function(d) { return countLeftLabelShift(d)})
        .attr("width", "100px")
        .text(function(d) { return d.target.edgeLabelLeft; })
        .style("overflow", "hidden")
        .attr("visibility", "hidden")
        .attr("font-weight", "bold");
}

function addNodes(canvas) {
    let id_counter = 0;
    let node = canvas.selectAll(".node")
        .data(nodes, function (d) { return d.id = nodes[id_counter++].nodeOrder; })
        .enter()
        .append("g")
        .attr("id", function(d) { return "g-node-" +d.id})
        .attr("class", "node")
        .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    return node;
}

function addNodeShape(node) {
    node.append("path")
        .style("stroke", "black")
        .attr("visibility", "hidden")
        .attr("id",function(d){return "node-"+d.id})
        .style("fill", function(d) { return d.nodeColor === 'blank' ? "white" : d.nodeColor })
        .attr("d", d3.svg.symbol()
            .size(function() { return typeof node_size === "undefined" ? 400 : node_size})
            .type(function(d) { return d.shape === "rectangle" ? "square" : "circle"}));
}

function addNodeName(node) {
    node.append("text")
        .attr("class", "nodeName")
        .text(function (d) {return d.name; })
        .attr("id",function(d){return "text-"+d.id})
        .attr("visibility", "hidden")
        .style("fill", function(d) { return typeof d.nodeColor === "undefined" ? "white" : "black" })
        .attr({
            "y" : 5,
            "x" : -4,
            "font-weight" : "bold"
        });
}

function addBottomLabel(node) {
    node.append("text")
        .attr("class", "label1")
        .text(function(d) { return d.label1; })
        .attr({
            "id" : function(d) { return "nodeLabel1-"+d.id; },
            "visibility" : "hidden",
            "text-anchor" : "middle",
            "y" : function() { return typeof node_size === "undefined" ? 400/between_node_label_gap : node_size/between_node_label_gap},
            "font-weight" : "bold",
        });
}

/*
Because of the fact that doing node.append("text") I cannot append more than one text element i had to do external
function which uses original "nodes" data and nodeOrder as a transformation index to current node elements
 */
function addSideLabels() {
    for(let i=0;i<nodes.length;i++) {
        if (typeof nodes[i].sideLabels !== "undefined") {
            for(let j=0; j<nodes[i].sideLabels.length; j++) {
                d3.select("#g-node-" + nodes[i].nodeOrder)
                    .append("text")
                    .attr("id","sideLabel-"+nodes[i].nodeOrder)
                    .attr("class", "sideLabels")
                    .attr("visibility", "hidden")
                    .text(nodes[i].sideLabels[j])
                    .attr({
                        "x" : 20,
                        "y" : (j*18)+5,
                        "font-weight" : "bold"
                    })
            }
        }
    }
}

function reveal(element) {
    d3.select(element).attr("visibility", "visible");
}

function revealAll(element) {
    d3.selectAll(element).attr("visibility", "visible");
}

function hide(element) {
    d3.select(element).attr("visibility", "hidden");
}

function hideAll(element) {
    d3.selectAll(element).attr("visibility", "hidden");
}

function revealBackJump(i) {
    if (typeof getNode(i).jump !== "undefined") {
        if (jumpOn) {
            if (treeRevealed) {
                d3.select("#jump-"+i).attr("stroke", "red")
            }
            else {
                reveal("#jump-"+i);
            }
            jumpOn = false;
        }
        else {
            jumpOn = true;
            counter--;
        }
    }
}

function hideBackJump(i) {
    if (typeof getNode(i).jump !== "undefined") {
        if (!jumpOn) {
            if (treeRevealed) {
                d3.select("#jump-"+i).attr("stroke", "black")
            }
            else {
                hide("#jump-"+i);
            }
            jumpOn = true;
            counter++;
        }
        else {
            jumpOn = false;
        }
    }
}

function showFrameOnly(i) {
    reveal("#link-" + (i - 1));
    reveal("#node-" + i);
    let node = getNode(i);
    if (node !== -1) {
        reveal("#treeLabel-" + (node.depth - 1));
    }
    revealBackJump(i)
}

function showNode(i) {
    if(treeRevealed) {
        if (typeof coloredLimit === "undefined" || i < coloredLimit+1) {
            if (show_frame) {
                reveal("#text-"+ (i+1));
                reveal("#nodeLabel1-"+ (i+1));
                reveal("#edgeLabelLeft-" + i);
                reveal("#edgeLabelRight-"+ i);
                revealAll("#sideLabel-"+ (i+1));
            }
            d3.select("#link-" + i)
                .attr("stroke", "red")
                .attr("stroke-width", stroke_width*2);
            revealBackJump(i+1); // nodes reveals 1-time faster than links
        }
    }
    else {
        reveal("#link-" + (i-1));
        reveal("#edgeLabelLeft-" + (i-1));
        reveal("#edgeLabelRight-"+ (i-1));
        reveal("#node-"+ i);
        reveal("#text-"+ i);
        reveal("#nodeLabel1-"+ i);
        reveal("#nodeLabel2-"+ i);
        revealAll("#sideLabel-"+ i);

        let node = getNode(i);
        if (node !== -1) {
            reveal("#treeLabel-" + (node.depth-1));
        }
        revealBackJump(i)
    }
}

function hideNode(i) {
    if(treeRevealed) {
        hideBackJump(i+1);
        i = counter;
        d3.select("#link-" + i)
            .attr("stroke", "black")
            .attr("stroke-width", stroke_width);
    }
    else {
        hideBackJump(i);
        i = counter;
        hide("#link-" + (i-1));
        hide("#edgeLabelLeft-" + (i-1));
        hide("#edgeLabelRight-"+ (i-1));
        hide("#node-"+ i);
        hide("#text-"+ i);
        hide("#nodeLabel1-"+ i);
        hide("#nodeLabel2-"+ i);
        hideAll("#sideLabel-"+ i);
        hide("#jump-"+i)
    }
}

function showTree() {
    if (animationOn) {
        pause();
    }
    for (let i = counter; i<=nodes.length; i++) {
        jumpOn = true;
        showNode(i);
    }
    treeRevealed = true;
    counter = 1;
    jumpOn = false;
}

function step() {
    if (animationOn) {
        pause();
    }
    if(counter <= nodes.length) {
        showNode(counter);
        counter++;
    }
}

function stepBack() {
    if (animationOn) {
        pause();
    }
    if(counter > 1) {
        counter--;
        hideNode(counter);
    }
}

function pause() {
    document.getElementById("animation").innerHTML = "Animation";
    document.getElementById("animation").style.backgroundColor = "";
    clearInterval(interval);
    animationOn = false;
}

function timeNodes() {
    if (show_frame && counter > coloredLimit) {
        pause();
    }
    else {
        if(counter <= nodes.length) {
            showNode(counter);
            counter++;
        }
        else {
            pause();
        }
    }
}

function animation() {
    if (animationOn) {
        pause();
    }
    else {
        if(counter < nodes.length) {
            document.getElementById("animation").innerHTML = "Pause";
            document.getElementById("animation").style.backgroundColor = "red";
            window.interval = setInterval(timeNodes, 500)
            animationOn = true;
        }
    }
}

function addTreeLabel(canvas) {
    nodes.forEach(function(d) { d.y = d.depth * tree_height; });
    let depthHash = _.uniq(_.pluck(nodes, "depth")).sort();
    depthHash.shift();
    let levelSVG = canvas.append("g")
        .attr("class", "levels-svg");
    levelSVG.selectAll("g.level")
        .data(depthHash)
        .enter()
        .append("g")
        .attr("class", "level")
        .attr("transform", function(d) { return "translate(" + -20 + "," + d*tree_height + ")"; })
        .append("text")
        .text(function(d){ return labels[d-1]; })
        .attr({
            "id" : function(d) { return "treeLabel-" + (d-1); },
            "visibility" : "hidden",
            "font-weight" : "bold",
            //"font-size" : "30px",
            "font-family" : "monospace"
        });
}

function reset() {
    if (animationOn) {
        pause();
    }
    d3.selectAll("svg").remove();
    show_frame = false;
    init();
    nodeGap = 0;
    counter = 1;
    treeRevealed = false;
    animationOn = false;
}

function restoreTree(restoreUntil) {
    for(let i=1; i < restoreUntil; i++) {
        step();
    }
}

function restore() {
    let restoreUntil = counter;
    let wasRevealed = treeRevealed;
    reset();
    if(wasRevealed) {
        showTree();
    }
    else {
        restoreTree(restoreUntil);
    }
}

heightSlider.oninput = function() {
    tree_height = this.value*36;
    restore();
};

widthSlider.oninput = function() {
    tree_width = this.value*320;
    restore();
};

function saveTreeToPng() {
    html2canvas(document.body).then(function(canvas) {
        let image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
        window.location.href=image;
    });
}

function showConfig() {
    if (cfg_shown) {
        document.getElementById("configFile").style.visibility = "hidden";
        document.getElementById("submit_button").style.visibility = "hidden";
        document.getElementById("help").style.visibility = "hidden";
        cfg_shown = false;
    }
    else {
        document.getElementById("configFile").style.visibility = "visible";
        document.getElementById("submit_button").style.visibility = "visible";
        document.getElementById("help").style.visibility = "visible";
        cfg_shown = true;
    }
}
document.getElementById("description").innerHTML = "<p><strong>CONFLICT-DIRECTED BACKJUMPING</strong></p><table><tr><th>Variable</th><th>Domain</th></tr><tr><td>x1</td><td>{ 1 2 3 }</td></tr><tr><td>x2</td><td>{ 2 3 }</td></tr><tr><td>x3</td><td>{ 1 }</td></tr><tr><td>x4</td><td>{ 1 2 }</td></tr><tr><td>x5</td><td>{ 2 3 }</td></tr><tr><td>x6</td><td>{ 1 3 4 }</td></tr><tr><td>x7</td><td>{ 1 2 }</td></tr><tr><th>Constraints</th></tr><tr><td>c1 : x1!=x2</td></tr><tr><td>c2 : x1!=x4</td></tr><tr><td>c3 : x1!=x7</td></tr><tr><td>c4 : x2!=x6</td></tr><tr><td>c5 : x3!=x7</td></tr><tr><td>c6 : x4!=x5</td></tr><tr><td>c7 : x4!=x7</td></tr><tr><td>c8 : x5!=x6</td></tr><tr><td>c9 : x5!=x7</td></tr></table>";
document.getElementById("configFile").value = "#CONFLICT-DIRECTED BACKJUMPING\n#x1 1 2 3,x2 2 3,x3 1,x4 1 2,x5 2 3,x6 1 3 4,x7 1 2\n#c1 : x1!=x2,c2 : x1!=x4,c3 : x1!=x7,c4 : x2!=x6,c5 : x3!=x7,c6 : x4!=x5,c7 : x4!=x7,c8 : x5!=x6,c9 : x5!=x7\n#description_size=16,node_size=400,edge_size=1.5,variable_label_size=20,node_label_size=16,show_frame=false,colored_limit=none\npath:=r0;name:=none;order:=1\npath:=r0x11;name:=1;order:=2\npath:=r0x11x22;name:=2;order:=3\npath:=r0x11x22x31;name:=1;order:=4;jump:=1\npath:=r0x11x22x31x41;name:=1;order:=5;shape:=square;color:=red;bottom_label:=(c2)\npath:=r0x11x22x31x42;name:=2;order:=6\npath:=r0x11x22x31x42x52;name:=2;order:=7;shape:=square;color:=red;bottom_label:=(c6)\npath:=r0x11x22x31x42x53;name:=3;order:=8\npath:=r0x11x22x31x42x53x61;name:=1;order:=9\npath:=r0x11x22x31x42x53x61x71;name:=1;order:=10;shape:=square;color:=red;bottom_label:=(c3);jump:=4\npath:=r0x11x23;name:=3;order:=11\npath:=r0x11x23x31;name:=1;order:=12\npath:=r0x11x23x31x41;name:=1;order:=13;shape:=square;color:=red;bottom_label:=(c2)\npath:=r0x11x23x31x42;name:=2;order:=14\npath:=r0x11x23x31x42x52;name:=2;order:=15;shape:=square;color:=red;bottom_label:=(c6)\npath:=r0x11x23x31x42x53;name:=3;order:=16\npath:=r0x11x23x31x42x53x61;name:=1;order:=17\npath:=r0x11x23x31x42x53x61x71;name:=1;order:=18;shape:=square;color:=red;bottom_label:=(c3);jump:=11\npath:=r0x12;name:=2;order:=19\npath:=r0x12x22;name:=2;order:=20;shape:=square;color:=red;bottom_label:=(c1)\npath:=r0x12x23;name:=3;order:=21;jump:=1\npath:=r0x12x23x31;name:=1;order:=22\npath:=r0x12x23x31x41;name:=1;order:=23\npath:=r0x12x23x31x41x52;name:=2;order:=24\npath:=r0x12x23x31x41x52x61;name:=1;order:=25\npath:=r0x12x23x31x41x52x61x71;name:=1;order:=26;shape:=square;color:=red;bottom_label:=(c5);jump:=21\npath:=r0x13;name:=3;order:=27\npath:=r0x13x22;name:=2;order:=28\npath:=r0x13x22x31;name:=1;order:=29\npath:=r0x13x22x31x41;name:=1;order:=30\npath:=r0x13x22x31x41x52;name:=2;order:=31\npath:=r0x13x22x31x41x52x61;name:=1;order:=32\npath:=r0x13x22x31x41x52x61x71;name:=1;order:=33;shape:=square;color:=red;bottom_label:=(c5);jump:=30\npath:=r0x13x22x31x41x53;name:=3;order:=34\npath:=r0x13x22x31x41x53x61;name:=1;order:=35\npath:=r0x13x22x31x41x53x61x71;name:=1;order:=36;shape:=square;color:=red;bottom_label:=(c5)\npath:=r0x13x22x31x41x53x61x72;name:=2;order:=37;color:=blank\npath:=r0x13x22x31x41x53x63;name:=3;order:=38;shape:=square;color:=red;bottom_label:=(c8)\npath:=r0x13x22x31x41x53x64;name:=4;order:=39\npath:=r0x13x22x31x41x53x64x71;name:=1;order:=40;shape:=square;color:=red;bottom_label:=(c5)\npath:=r0x13x22x31x41x53x64x72;name:=2;order:=41;color:=blank\npath:=r0x13x22x31x42;name:=2;order:=42\npath:=r0x13x22x31x42x52;name:=2;order:=43;shape:=square;color:=red;bottom_label:=(c6)\npath:=r0x13x22x31x42x53;name:=3;order:=44\npath:=r0x13x22x31x42x53x61;name:=1;order:=45\npath:=r0x13x22x31x42x53x61x71;name:=1;order:=46;shape:=square;color:=red;bottom_label:=(c5);jump:=29\npath:=r0x13x23;name:=3;order:=47;shape:=square;color:=red;bottom_label:=(c1)";
</script>
</html>